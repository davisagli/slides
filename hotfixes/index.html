<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml"><head><title>Patching Plone</title><meta name="generator" content="Hovercraft! 1.0 http://regebro.github.com/hovercraft"></meta><link rel="stylesheet" href="css/hovercraft.css" media="all"></link><link rel="stylesheet" href="css/impressConsole.css" media="all"></link><link rel="stylesheet" href="css/highlight.css" media="all"></link><link rel="stylesheet" href="slideshow.css" media="screen,projection"></link></head><body class="impress-not-supported"><div id="impress" data-transition-duration="300"><div class="step" step="0" data-x="0" data-y="0"><h1 id="patching-plone">Patching Plone</h1><h2 id="with-the-power-of-python">with the power of Python</h2><div class="line-block"><br></br></div><h2 id="david-glick">David Glick</h2><h3 id="pycologne-feb-2014">PyCologne, Feb 2014</h3></div><div class="step" step="1" data-x="1600" data-y="0"><h1 id="the-problem">The Problem</h1><p>Software has bugs</p></div><div class="step" step="2" data-x="3200" data-y="0"><h1 id="id1">The Problem</h1><p>Some of them are security holes</p></div><div class="step" step="3" data-x="4800" data-y="0"><h1 id="id2">The Problem</h1><p>You can't always upgrade</p><div class="notes"><p>If we used PHP, we wouldn't have many options. cf. security releases of Drupal, Wordpress.</p><p>We can do better.</p></div></div><div class="step" step="4" data-x="6400" data-y="0"><h1 id="monkey-patching">Monkey Patching</h1></div><div class="step" step="5" data-x="8000" data-y="0"><pre class="highlight code python"><span class="c"># frontend.py</span>

<span class="k">def</span> <span class="nf">render_link</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="k">return</span> <span class="s">'&lt;a href="{}"&gt;{}&lt;/a&gt;'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span></pre></div><div class="step" step="6" data-x="9600" data-y="0"><pre class="highlight code python"><span class="kn">import</span> <span class="nn">cgi</span>
<span class="kn">import</span> <span class="nn">frontend</span>
<span class="n">old_render_link</span> <span class="o">=</span> <span class="n">frontend</span><span class="o">.</span><span class="n">render_link</span>
<span class="k">def</span> <span class="nf">new_render_link</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="n">sanitized_url</span> <span class="o">=</span> <span class="n">cgi</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">old_render_link</span><span class="p">(</span><span class="n">sanitized_url</span><span class="p">)</span>
<span class="n">frontend</span><span class="o">.</span><span class="n">render_link</span> <span class="o">=</span> <span class="n">new_render_link</span></pre></div><div class="step" step="7" data-x="11200" data-y="0"><h1 id="plone-hotfixes">Plone hotfixes</h1><p>Organized monkey patching</p><div class="notes"><p>Benefits:</p><ul><li>Released on 4-month schedule</li><li>Can install as egg or simple module</li><li>Wrap in try/except so the hotfix can safely be added to old systems</li><li>Log success so admin can check if it applied</li></ul></div></div><div class="step" step="8" data-x="12800" data-y="0"><h1 id="problem-with-monkey-patching">Problem with monkey patching</h1><p>If the system imports a module global,
and <em>then</em> the hotfix runs and patches that global,
the early imports still reference the unpatched code.</p></div><div class="step" step="9" data-x="14400" data-y="0"><h1 id="marmoset-patching">Marmoset patching</h1><img src="marmoset.jpg" alt="" width="" height=""></img><p>Replace the function's bytecode instead of the
namespace's reference to the function.</p></div><div class="step" step="10" data-x="16000" data-y="0"><pre class="highlight code python"><span class="n">code</span> <span class="o">=</span> <span class="s">"""
def old_render_link(url):
        pass

def new_render_link(url):
    sanitized_url = cgi.escape(url)
    return old_render_link(sanitized_url)
"""</span>
<span class="kn">from</span> <span class="nn">frontend</span> <span class="kn">import</span> <span class="n">render_link</span>
<span class="k">exec</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">frontend</span><span class="o">.</span><span class="n">render_link</span><span class="o">.</span><span class="n">func_globals</span>
<span class="n">frontend</span><span class="o">.</span><span class="n">old_render_link</span><span class="o">.</span><span class="n">func_code</span> <span class="o">=</span> <span class="n">frontend</span><span class="o">.</span><span class="n">render_link</span><span class="o">.</span><span class="n">func_code</span>
<span class="n">frontend</span><span class="o">.</span><span class="n">render_link</span><span class="o">.</span><span class="n">func_code</span> <span class="o">=</span> <span class="n">frontend</span><span class="o">.</span><span class="n">new_render_link</span><span class="o">.</span><span class="n">func_code</span></pre><h1 id="questions">Questions?</h1><dl><dt>Email</dt><dd><p><a href="mailto:david@glicksoftware.com">david@glicksoftware.com</a></p></dd><dt>IRC</dt><dd><p>davisagli</p></dd></dl></div></div><div id="hovercraft-help"><table><tr><th>Space</th><td>Forward</td></tr><tr><th>Left, Down, Page Down</th><td>Next slide</td></tr><tr><th>Right, Up, Page Up</th><td>Previous slide</td></tr><tr><th>P</th><td>Open presenter console</td></tr><tr><th>H</th><td>Toggle this help</td></tr></table></div><script type="text/javascript" src="js/impress.js"></script><script type="text/javascript" src="js/impressConsole.js"></script><script type="text/javascript" src="js/hovercraft.js"></script></body></html>